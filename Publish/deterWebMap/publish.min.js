$(function(){var e,n,t={},i={},o=$("#legend"),a=$("#loader"),r=$("#loader-message"),l=$("#loader-message-text"),s=$("#layer-description"),c=$("#properties"),u=$("#legends"),d=$("#description-title"),p=$("#legend-title"),f=$("#layers-title"),h=$("#download-title"),m=$("#panel-download"),g=$(".mini-submenu-left"),v=$(".sidebar"),b=$(".sidebar-left .sidebar-body"),y=$(".sidebar-left .slide-submenu"),w=$("#modal-app-description"),P=$("#modal-completed-description"),x=$("#modal-title-description"),C=$("#info-description"),k=$("#map"),M=$("#more"),S=$("#layers"),L=S.find("label"),O=L.find("input"),T=L.find("a"),z=$("#play"),I=$("#slider"),W=$("#slider-container"),D=$("#slider-col"),V=null,G=$("#spanSelectedYear"),N=$("#scenario-combobox"),j=$("#scenario-description"),E=$("#more-scenario-description"),Y=$("#modal-scenario-completed-description"),Z=$("#modal-scenario-title-description"),J=$("#scenario-info-description"),R=$(".navbar").height(),_=k.height(),F=[],H=[],B=[],A={},U={},q={},K={},Q={},X=!1,ee=!1,ne=!1,te=Publish.interval||1e3,ie={Point:"Point",MultiPoint:"MultiPoint",LineString:"LineString",MultiLineString:"MultiLineString",WMS:"WMS"};function oe(e){o.empty(),p.text("  "+Publish.legend);var n=[];$.each(e,function(e){n.push(e)}),n.sort(),$.each(n,function(n,t){var i,a,r,l,s=e[t];i=o,a=s,r=t,l=$('<div style="height:25px;">'),a.endsWith(".png")?l.append($('<div class="legend-img-box">').css("background-image","url("+a+")")):l.append($('<div class="legend-color-box">').css({backgroundColor:a})),l.append($("<span>").css("lineHeight","23px").html(r)),i.append(l)})}function ae(e){return{fillColor:e.getProperty("color"),strokeColor:e.getProperty("border"),strokeWeight:e.getProperty("width"),zIndex:e.getProperty("order"),icon:e.getProperty("icon")}}function re(e,n,t){var i=t.geom||e.getGeometry().getType(),o=Ge(t,1),a=function(e){var n=e.color;if(e.slices){var t=Object.keys(n).sort(function(e,n){return e-n}),i=t.map(Number);return function(e){var o=null;return $.each(i,function(i,a){e>=a&&(o=n[t[i]])}),o}}return function(e){return n[e]}}(t);if(!t.icon||i!==ie.Point&&i!==ie.MultiPoint){var r=o||n,l=t.color;"object"===$.type(l)?e.setProperty("color",a(e.getProperty(r))):e.setProperty("color",l),e.setProperty("border",t.border),e.setProperty("width",t.width)}else{var s=t.icon.options[e.getProperty(o)];s||(s=t.icon.path),e.setProperty("icon",s)}e.setProperty("order",t.order)}function le(e,n,i){e.setStyle(ae),i.report&&e.addListener("click",function(e){if("function"===i.report){var t=e.feature.getProperty(Ge(i,0));"string"===$.type(t)&&(t=t.replace(/\s/g,"")),$("#modal-report-"+n+t).modal("show")}else $("#modal-report-"+n).modal("show")}),t[n]=e}function se(e,n,t){$.each(n,function(n,i){var o,a;i.getVisible()?(o=e,(a=i).setMap(null),a.setVisible(!1),window.intervals&&$.each(window.intervals[o],function(e,n){clearInterval(n)})):(ye(e,i,t),ge(e,c.hasClass("in"),u.hasClass("in")))})}function ce(e){return e.geom===ie.LineString}function ue(e){return e.geom===ie.MultiLineString}function de(e){return ce(e)||ue(e)}function pe(n,i,o){var a=i.visible,r=i.time?i.id:n;if("WMS"===i.geom){var l=new $.Deferred,s=i.time?n:i.name,c=new geoambiente.maps.WmsLayer({url:i.url,layer:s,visibility:a,opacity:i.transparency,map:e});return l.resolve(c),t[n]=c,a&&Ve(r,!0),ne||(ne=!0),o&&o(c),l.promise()}var u=Publish.path+n+".geojson";return $.getJSON(u,function(l){var s,c,u,d,p,f,h,m,g,v=new google.maps.Data;v.addGeoJson(l),de(i)?(d=v,p=n,h=[],m=(f=i).visible,g=f.icon.time,d.forEach(function(e){var n=e.getGeometry();if(ce(f)){var t=$e(f,n);h.push(t),m&&ye(p,t,g)}else if(ue(f)){var i=[];$.each(n.getArray(),function(e,n){var t=$e(f,n);i.push(t),m&&ye(p,t,g)}),h.push(i)}}),t[p]=h,m&&Ve(p,!0)):(c=n,u=i,(s=v).forEach(function(e){re(e,c,u)}),le(s,c,u),a&&(v.setMap(e),Ve(r,!0)),o&&o(v))})}function fe(){var e=B[0],n=B[1];if(null!=e&&null!=n)for(var t=e;t<=n;t++)Se(t)}function he(n,t){var i,o;A[n]?(o=n,t.setMap(null),Ve(o,!1)):(i=n,t.setMap(e),Ve(i,!0),ge(i,c.hasClass("in"),u.hasClass("in")))}function me(e){var n,i,o,a,r,s=Publish.data[e];if(s.time)A[r=e]?Ve(r,!1):(Ve(r,!0),ge(r,c.hasClass("in"),u.hasClass("in"))),fe();else{var d=t[e];d?de(s)?(i=e,o=d,a=(n=s).icon.time,ce(n)?se(i,o,a):$.each(o,function(e,n){se(i,n,a)})):he(e,d):(Pe(),l.empty(),we(e,1,1),s.visible=!0,pe(e,s).done(function(){ge(e,c.hasClass("in"),u.hasClass("in"))}).always(function(){xe()}))}}function ge(e,t,o){n=e;var a,r,l,f,g,v,b,y,w,P,k=Publish.data[e];if(a=k,r=i[e],l=a.label,f=r||"Description",g=a.description||"",v=g.split("."),b=v[0]?v[0]+".":"",w=40*(_-(y=R+40))/100,P=20*(_-y)/100,S.height()<w&&(P=30*(_-y)/100),S.css("max-height",w),c.css("max-height",P),u.css("max-height",P),v.length-1>1?M.show():M.hide(),d.text(" "+f),s.text(b),x.text(" "+f),C.text(g),oe(l),t||(d.prop("disabled",!1),d.click()),o||(p.prop("disabled",!1),p.click()),k.download){var L=e+".zip";h.prop("href",Publish.path+L),h.prop("download",L),m.show()}else m.hide();T.removeClass("button-selected"),$("#"+e).addClass("button-selected")}function ve(e){var t=e.target.id;if(t){var i,a,r=c.hasClass("in"),l=u.hasClass("in");n===t?(i=r,a=l,n=null,o.empty(),s.empty(),d.text(" Description"),m.hide(),$("button").removeClass("button-selected"),i&&(d.click(),d.prop("disabled",!0)),a&&(p.click(),p.prop("disabled",!0))):ge(t,r,l)}}function be(e){var n=e.target.name;if(n){var t=Publish.group;if(t){var i=Publish.data[n].group,o=t[i];o?(me(o),o===n?t[i]=null:(t[i]=n,me(n))):(t[i]=n,me(n))}else me(n);Me()}}function $e(e,n){var t=e.icon.options,i=[];n.forEachLatLng(function(e){i.push(e)});var o={path:t.path,anchor:new google.maps.Point(175,175),scale:.1,fillColor:t.fillColor,fillOpacity:t.fillOpacity,strokeWeight:t.strokeWeight},a={path:i,icons:[{icon:o}],strokeWeight:e.width,strokeColor:e.border||e.color,strokeOpacity:e.transparency};return new google.maps.Polyline(a)}function ye(n,t,i){var o,a,r,l;t.setMap(e),t.setVisible(!0),o=n,a=t,r=0,l=setInterval(function(){r=(r+1)%200;var e=a.get("icons");e[0].offset=r/2+"%",a.set("icons",e)},i),window.intervals||(window.intervals={}),window.intervals[o]||(window.intervals[o]=[]),window.intervals[o].push(l)}function we(e,n,t){var o,a,r=(o=n,a=t,"Loading"+i[e]+" ("+o+"/"+a+")");l.text(r)}function Pe(){a.fadeIn(),r.css("z-index",1e7)}function xe(){a.fadeOut(),l.empty(),r.css("z-index",-1)}function Ce(e){var n=[];return $.each(e,function(e,t){n.push(t)}),n}function ke(){I.slider({range:!0,min:0,max:H.length-1,step:1,values:[0,H.length-1]}).each(Oe).on("slide",Le),Me()}function Me(){if(X)if(1===H.length)V||(V=W.detach());else{var e=function(){var e=!1;X&&F.length>0&&$.each(F,function(n,t){if(A[t.type])return e=!0,!1});return e}();e&&null!==V?(V.appendTo(D),V=null):e||null!==V||(V=W.detach())}}function Se(n){$.each(F,function(t,i){var o=null;A[i.type]&&i.year===H[n]&&(o=e),i.layer.setMap(o)})}function Le(e,n){var t=H.length-1,i=n.values[1],o=i/t*100-1||0;G.css("left",o+"%"),B=n.values,Se(i)}function Oe(){var e=0,n=H.length,t=n-1;if(B=[0,t],$.each(H,function(n,i){var o=e/t*100||0,a=$("<label>"+i+"</label>").css("left",o+"%");I.append(a),e++}),n>0){var i=100/n;if(i<6){var o=.6*k.width(),a=W.width()*(6/i);a>o&&(a=o),W.width(a)}}}function Te(e,n,t,i,o){var a,r,l,s,c=(a=e,r=!1,$.each(H,function(e,n){n===a&&(r=!0)}),r),u=(l=e,s=0,$.each(H,function(e,n){return n===l?e:l<n?e:void s++}),s);c?ze(t,n,e,i,o):(H.splice(u,0,e),ze(t,n,e,i,o))}function ze(e,n,t,i,o){F.push({type:e,layer:n,year:t,time:i,scenario:o})}function Ie(){O.prop("disabled",!0),T.off("click"),z.prop("disabled",!0),I.slider("disable");var n=H.length-1,t=B[0],i=B[1],o=null,a=null;function r(){G.css("left",t/n*100-1+"%"),Se(t),t++}function l(){O.prop("disabled",!1),T.click(ve),z.prop("disabled",!1),I.slider("enable")}ne?(a=function(){t<=i?(google.maps.event.addListenerOnce(e,"tilesloaded",function(){setTimeout(a,te)}),r()):l()})():(a=function(){t<=i?r():(clearInterval(o),l())},o=setInterval(a,te))}function We(){!function(){if(K.currentScenario){var e=Publish.data[K.currentView].scenario[K.currentScenario];$.each(e.name,function(e,n){t[n].setMap(null)}),H=Ce(K.timelineYears),F=Ce(K.timelineLayers),K.currentScenario=null,K.currentView=null}}();var e=$("#scenarioSeparator"),n=N.find("option:selected").text().trim(),i=N.find("option:selected").val();if(i){n=Publish.scenarioWrapper[n],0===e.length&&(e=$('<br id="scenarioSeparator"/>')).insertBefore(j);var o=Q[n];if(o)H=Ce(o.timelineYears),F=Ce(o.timelineLayers),K.currentScenario=n,K.currentView=i,I.find("label").remove(),ke(),fe();else{var a=[],r=Publish.data[i],l=r.scenario[n];Pe();var s=0,c=r.time;$.each(l.name,function(e,t){var o=l.timeline[s];a.push(pe(t,r,function(e){Te(o,e,i,c,n)})),s++}),$.when.apply($,a).always(function(){K.currentScenario=n,K.currentView=i,Q[n]={timelineYears:Ce(H),timelineLayers:Ce(F)},I.find("label").remove(),ke(),xe(),fe()})}var u=Publish.scenario[n],d=u.split("."),p=d[0]?d[0]+".":"";d.length-1>1?E.show():E.hide(),j.text(p),Z.text(" "+n),J.text(u)}else I.find("label").remove(),ke(),fe(),e.length>0&&e.remove(),j.text(""),E.hide()}function De(){if(g.is(":visible"))k.find(".ol-zoom").css("margin-left",0).removeClass("zoom-top-opened-sidebar").addClass("zoom-top-collapsed");else{var e=$(".sidebar-left");k.find(".ol-zoom").css("margin-left",e.width()).removeClass("zoom-top-opened-sidebar").removeClass("zoom-top-collapsed")}}function Ve(e,n){var t;A[e]!==n&&(A[e]=n,ee&&e===K.currentView&&N.val("").change(),U[e].prop("checked",n)),ee&&(t=!1,ee&&$.each(A,function(e,n){if(n&&q[e])return t=!0,!1}),t?N.prop("disabled",!1):N.prop("disabled",!0))}function Ge(e,n){return"array"===$.type(e.select)?e.select[n]:e.select}google.maps.event.addDomListener(window,"load",function(){google.maps.visualRefresh=!0;var n={center:new google.maps.LatLng(Publish.center.lat,Publish.center.long),zoom:function(e,n){if("number"===$.type(e))return e;function t(e,n,t){return Math.floor(Math.log(e/n/t)/Math.LN2)}var i=t(_,e.yTile,e.latFraction),o=t(k.width(),e.xTile,e.longFraction);return Math.min(i,o,n)}(Publish.zoom,Publish.maxZoom),minZoom:Publish.minZoom,maxZoom:Publish.maxZoom,mapTypeId:google.maps.MapTypeId[Publish.mapTypeId],mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_RIGHT}};(e=new google.maps.Map(k[0],n)).controls[google.maps.ControlPosition.BOTTOM_RIGHT].push($("#footer")[0]),O.each(function(e,n){U[n.name]=$(n)}),T.each(function(e,n){i[n.id]=n.innerText,A[n.id]=!1}),O.click(be),T.click(ve),z.click(Ie),N.change(We),d.prop("disabled",!0),p.prop("disabled",!0),f.text("  "+Publish.layers),m.hide(),google.maps.event.addListenerOnce(e,"idle",function(){!function(n){var t=[],i=0,o=Object.keys(n).length,a=!1;Pe(),$.each(n,function(n,r){var s;(s=r).label||(s.label={},s.label[s.id]=s.color||s.border||"rgba(0, 0, 0, 1)");var c=r.visible,u=r.time;if(r.scenario&&(q[n]=!0,ee||(ee=!0)),!c&&!u)return!0;if(i+=1,l.empty(),we(n,i,o),u){var d=0;if("creation"===u){var p=Publish.path+n+".geojson";t.push($.getJSON(p,function(t){var i=new google.maps.Data;i.addGeoJson(t);var o={};$.each(r.timeline,function(e,n){o[n]=new google.maps.Data});var a=r.name;i.forEach(function(e){re(e,n,r);var t=e.getProperty(a),i=o[t];i&&i.add(e)}),r.name=[],$.each(o,function(t,i){var o=n+"_"+t;le(i,o,r),Te(t,i,n,u),r.name.push(o),d++,c&&(i.setMap(e),Ve(n,!0))})}))}else $.each(r.name,function(e,i){var o=r.timeline[d];t.push(pe(i,r,function(e){Te(o,e,n,u)})),d++});!X&&c&&(X=!0,a=!0)}else t.push(pe(n,r))});var r=c.hasClass("in"),s=u.hasClass("in");ge(T[0].id,r,s),$.when.apply($,t).always(function(){a&&X&&(ke(),K.timelineYears=Ce(H),K.timelineLayers=Ce(F),K.backup=Ce(H)),xe()})}(Publish.data)})}),y.on("click",function(){$(this).closest(".sidebar-body").fadeOut("slide",function(){g.fadeIn(),De()})}),g.on("click",function(){var e=$(this);b.toggle("slide"),e.hide(),De()}),M.on("click",function(){P.modal("show")}),E.on("click",function(){Y.modal("show")}),$(window).on("resize",De),w.modal("show"),function(){if(v.width()===$(window).width()&&(b.fadeOut("slide"),g.fadeIn()),$("#logo")){var e=R-50;$("body").css("padding-top",e),g.css("margin-top",e)}var n=Publish.fontSize;if(n){var t=$(".custom-font-layer"),i=$(".custom-font-app-title"),o=$(".custom-font-group-title"),a=$(".custom-font-report-title"),r=$(".custom-font-subtitle"),l=$(".custom-font-body"),s=$(".custom-font-legend"),c=$(".custom-font-more "),u="font-size",d=function(e){return parseFloat(e.css(u))},p=function(e,n){e.css(u,n+"px")},f=d(t),h=function(e){var t=d(e)-f;p(e,n+t)};p(t,n),h(i),h(o),h(a),h(r),h(l),h(s),h(c)}}(),De()});