function _openInfoWindow(){__idx=0,$.isEmptyObject(geoambiente.infowindow)&&(geoambiente.infowindow=new google.maps.InfoWindow({minWidth:400,maxWidth:400})),geoambiente.infowindow.setContent(_getContent()),geoambiente.infowindow.open(map),geoambiente.infowindow.setPosition(__evt.latLng)}function _getContent(){var e=geoambiente.features[__idx],t="<div id='divContent'>";t+="<center><b>"+e.id+"</b></div>";for(var i in e.properties)t+="<br><b>"+i+":</b> "+e.properties[i];return t+="</div>",geoambiente.features.length>1&&(t+="<br><br><br>",t+="<div id='divPagination'>",__idx>0&&(t+="<a href='javascript:;' onclick='_previous();'>Anterior</a> "),__idx<geoambiente.features.length-1&&(t+="<a href='javascript:;' onclick='_next();'>Pr&oacute;ximo</a> "),t+="</div>"),t}function _next(){__idx=__idx==geoambiente.features.length-1?0:__idx+1,geoambiente.infowindow.setContent(_getContent())}function _previous(){__idx=0===__idx?geoambiente.features.length-1:__idx-1,geoambiente.infowindow.setContent(_getContent())}function _generateHexString(){for(var e="";e.length<10;)e+=Math.random().toString(16).substring(2);return e.substring(0,10)}var geoambiente=geoambiente||{};geoambiente.maps={},geoambiente.layers=geoambiente.layers||[],geoambiente.events=geoambiente.events||{},geoambiente.features=geoambiente.features||[],geoambiente.services=geoambiente.services||[],geoambiente.idx=geoambiente.idx||-1,geoambiente.infowindow=geoambiente.infowindow||{},geoambiente.proxy=geoambiente.proxy||"proxy.ashx",geoambiente.servicesTypes=geoambiente.servicesTypes||{},geoambiente.servicesTypes.Wms="WmsLayer",geoambiente.servicesTypes.Tiled="TiledLayer",geoambiente.maps.WmsLayer=function(e){function t(){return o.url}function i(){return o.map}function n(){return o.visibility}function a(e){o.visibility=e}if(null==$)throw Error("geoambiente.maps.WmsLayer jQuery is not declared.");if(null==e)throw Error("geoambiente.maps.WmsLayer parameters declared.");if(null==e.map)throw Error("geoambiente.maps.WmsLayer google maps instance not declared.");var o={map:null,url:null,bbox:null,suppressinfowindows:!1,layer:null,transparent:!0,filter:null,tiled:!0,format:"image/png",url_optional:"",opacity:.8,infowindow:{},visibility:!0};$.extend(o,e),this.layerId=o.layer,this.layerKey=_generateHexString(),this.loadLayer=function(){this.geoLayer=new google.maps.ImageMapType({getTileUrl:function(e,t){Math.pow(2,t);if(!(e.x<0||e.y<0||e.x>=1<<t||e.y>=1<<t)){initialResolution=2*Math.PI*6378137/256,originShift=2*Math.PI*6378137/2,res=initialResolution/Math.pow(2,t);var i=new google.maps.Point;i.x=e.x,i.y=(1<<t)-e.y-1;var n=256*i.x*res-originShift+","+(256*i.y*res-originShift)+","+(256*(i.x+1)*res-originShift)+","+(256*(i.y+1)*res-originShift),a=o.url+"?";return a+="&service=WMS",a+="&version=1.1.1",a+="&request=GetMap",a+="&layers="+o.layer,a+="&format="+o.format,a+="&tiled="+o.tiled,a+="&TRANSPARENT="+o.transparent,a+="&srs=EPSG:900913",a+="&bbox="+n,""!=o.url_optional&&(a+="&"+o.url_optional+"&"),a+="&width=256",a+="&height=256"}},tileSize:new google.maps.Size(256,256),opacity:o.opacity,isPng:!0}),this.geoLayer.name=o.layer,this.geoLayer.settings=o;var e=$.inArray(this.geoLayer,geoambiente.layers);-1==e&&geoambiente.layers.push(this.geoLayer),e=$.inArray(this.geoLayer,geoambiente.layers),o.visibility?o.map.overlayMapTypes.setAt(e,this.geoLayer):o.map.overlayMapTypes.setAt(e,null),jQuery.isEmptyObject(geoambiente.events)&&(geoambiente.events=google.maps.event.addListener(map,"click",function(e){geoambiente.infowindowExecute(e)}))},this.loadLayer(),this.context=this,this.getWmsUrl=function(){return t()},this.getVisibility=function(){return n()},this.getMap=function(){return i()},this.setMap=function(e){var t=$.inArray(this.geoLayer,geoambiente.layers);null==e?(o.map.overlayMapTypes.setAt(t,null),a(!1)):(o.map.overlayMapTypes.setAt(t,this.geoLayer),a(!0))},this.destroy=function(){var e=$.inArray(this.geoLayer,geoambiente.layers);o.map.overlayMapTypes.removeAt(e),geoambiente.layers.splice(e,1)},this.reorder=function(e){var t=$.inArray(this.geoLayer,geoambiente.layers);if(e>=geoambiente.layers.length)for(var i=e-geoambiente.layers.length;1+i--;)geoambiente.layers.push(void 0);geoambiente.layers.splice(e,0,geoambiente.layers.splice(t,1)[0]),o.map.overlayMapTypes.clear();for(var n in geoambiente.layers)geoambiente.layers[n].settings.visibility&&o.map.overlayMapTypes.setAt(n,geoambiente.layers[n])}},geoambiente.maps.TiledLayer=function(e){function t(){return a.visibility}function i(e){a.visibility=e}function n(e,t){var i=e.y,n=e.x,a=1<<t;return i<0||i>=a?null:((n<0||n>=a)&&(n=(n%a+a)%a),{x:n,y:i})}if(null==$)throw Error("geoambiente.maps.WmsLayer jQuery is not declared.");if(null==e)throw Error("geoambiente.maps.WmsLayer parameters declared.");if(null==e.map)throw Error("geoambiente.maps.WmsLayer google maps instance not declared.");var a={map:null,url:null,formatImage:"png",infowindow:{}};$.extend(a,e),this.layerKey=_generateHexString(),this.loadLayer=function(){this.geoLayer=new google.maps.ImageMapType({getTileUrl:function(e,t){var i=(Math.pow(2,t),Math.pow(2,t),n(e,t)),o=Math.pow(2,t),r=t,s=i.x,g=o-i.y-1;return a.url+"/"+r+"/"+s+"/"+g+"."+a.formatImage},tileSize:new google.maps.Size(256,256),isPng:!0}),this.geoLayer.settings=a;var e=$.inArray(this.geoLayer,geoambiente.layers);-1==e&&geoambiente.layers.push(this.geoLayer),e=$.inArray(this.geoLayer,geoambiente.layers),a.map.overlayMapTypes.setAt(e,this.geoLayer)},this.loadLayer(),this.context=this,this.getVisibility=function(){return t()},this.setMap=function(e){var t=$.inArray(this.geoLayer,geoambiente.layers);null==e?(a.map.overlayMapTypes.setAt(t,null),i(!1)):(a.map.overlayMapTypes.setAt(t,this.geoLayer),i(!0))},this.destroy=function(){var e=$.inArray(this.geoLayer,geoambiente.layers);a.map.overlayMapTypes.removeAt(e),geoambiente.layers.splice(e,1)}},geoambiente.infowindowExecute=function(e){var t=geoambiente.layers.filter(function(e){return!jQuery.isEmptyObject(e.settings.infowindow)}),i=[];geoambiente.features=[],__evt=e,$.each(t,function(e,t){-1==$.inArray(t.settings.infowindow.url,i)&&i.push(t.settings.infowindow.url)}),geoambiente.services=[],$.each(i,function(e,i){var n=t.filter(function(e){return e.settings.infowindow.url==i});geoambiente.services.push({url:i,layers:n.map(function(e){return e.settings.layer}).join(",")})}),$.isEmptyObject(geoambiente.services)||(geoambiente.idx=0,geoambiente.getFeature(__evt))},geoambiente.getFeature=function(e){if(geoambiente.idx>geoambiente.services.length-1)return void(geoambiente.features.length>0&&_openInfoWindow());var t=geoambiente.services[geoambiente.idx],i=map.getBounds().toUrlValue().split(",")[1]+","+map.getBounds().toUrlValue().split(",")[0]+","+map.getBounds().toUrlValue().split(",")[3]+","+map.getBounds().toUrlValue().split(",")[2],n=t.url+"?";n+="&SERVICE=WMS",n+="&REQUEST=GetFeatureInfo",n+="&BBOX="+i,n+="&INFO_FORMAT=application/json",n+="&QUERY_LAYERS="+t.layers,n+="&LAYERS="+t.layers,n+="&FEATURE_COUNT=10",n+="&WIDTH="+$(map.getDiv()).width(),n+="&HEIGHT="+$(map.getDiv()).height(),n+="&FORMAT=image/png",n+="&STYLES=",n+="&SRS=EPSG:4326",n+="&VERSION=1.1.1",n+="&x="+parseInt(e.pixel.x),n+="&y="+parseInt(e.pixel.y);var a=n;$.post(geoambiente.proxy,{url:a},function(e,t){$.each(e.features,function(e,t){geoambiente.features.push(t)}),geoambiente.idx++,geoambiente.getFeature(__evt)})};